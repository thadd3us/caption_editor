<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Drag-and-Drop Test v2</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    h1 {
      color: #333;
      margin-top: 0;
    }

    .info {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    #dropzone {
      border: 3px dashed #667eea;
      border-radius: 10px;
      padding: 60px;
      text-align: center;
      background: #f9f9ff;
      margin: 20px 0;
      transition: all 0.3s;
      cursor: pointer;
    }

    #dropzone:hover {
      background: #f0f0ff;
      border-color: #764ba2;
      transform: scale(1.02);
    }

    #dropzone.dragover {
      background: #e8e8ff;
      border-color: #764ba2;
      transform: scale(1.05);
    }

    #dropzone h2 {
      color: #667eea;
      margin: 0 0 10px 0;
    }

    #results {
      margin-top: 20px;
    }

    .result-item {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      border-left: 4px solid #667eea;
    }

    .result-item.success {
      border-left-color: #27ae60;
      background: #e8f5e9;
    }

    .result-item.error {
      border-left-color: #e74c3c;
      background: #ffebee;
    }

    .console {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-line {
      margin: 3px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ File.path Test v2</h1>

    <div class="info">
      <strong>Test:</strong> Does f.path work in renderer with contextIsolation?<br>
      <strong>Setup:</strong> contextIsolation: true, no nodeIntegration<br>
      <strong>Expected:</strong> If f.path exists, we can send it via IPC
    </div>

    <div id="dropzone">
      <h2>‚¨áÔ∏è Drop files here</h2>
      <p>We'll try to access f.path and send to main process</p>
    </div>

    <div id="results"></div>

    <div class="console" id="console">
      <div class="log-line">[renderer] Ready - waiting for drops...</div>
    </div>
  </div>

  <script>
    const dropzone = document.getElementById('dropzone');
    const resultsDiv = document.getElementById('results');
    const consoleDiv = document.getElementById('console');

    function log(message, type = 'info') {
      console.log(message)
      const line = document.createElement('div');
      line.className = 'log-line';
      line.textContent = message;
      consoleDiv.appendChild(line);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    log('[renderer] Script loaded')
    log('[renderer] window.fileDrop available: ' + !!window.fileDrop)

    // Prevent browser from opening the file
    document.addEventListener('dragover', e => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });

    document.addEventListener('dragleave', e => {
      dropzone.classList.remove('dragover');
    });

    document.addEventListener('drop', e => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      log('[renderer] ==================== DROP ====================')
      log('[renderer] Files dropped: ' + e.dataTransfer.files.length)

      const files = Array.from(e.dataTransfer.files);

      log('[renderer] Testing THREE methods to get file paths:')
      log('[renderer] ')

      // Method 1: Old way (f.path) - doesn't work
      log('[renderer] Method 1: f.path (old way)')
      files.forEach((f, i) => {
        log(`[renderer]   File ${i}: ${f.name}`)
        log(`[renderer]   - f.path: ${f.path}`)
        log(`[renderer]   - Result: ${f.path ? '‚úì WORKS' : '‚úó UNDEFINED'}`)
      });

      // Method 2: webUtils.getPathForFile (new way)
      log('[renderer] ')
      log('[renderer] Method 2: webUtils.getPathForFile (new API)')
      log('[renderer] Checking if API is available: ' + !!window.fileDrop.getPathForFile)

      const paths = [];
      if (window.fileDrop.getPathForFile) {
        files.forEach((f, i) => {
          log(`[renderer]   File ${i}: ${f.name}`)
          const path = window.fileDrop.getPathForFile(f);
          log(`[renderer]   - Path: ${path}`)
          log(`[renderer]   - Result: ${path ? '‚úì WORKS' : '‚úó FAILED'}`)
          paths.push(path);
        });
      } else {
        log('[renderer]   ‚úó API not available!')
      }

      log('[renderer] ')
      log('[renderer] ==========================================')

      if (paths.length > 0 && paths.some(p => p)) {
        log('[renderer] ‚úì SUCCESS: Got file paths using webUtils!')
        log('[renderer] ‚úì Paths: ' + JSON.stringify(paths))
        log('[renderer] ‚úì Sending to main process via IPC...')
        window.fileDrop.sendPaths(paths);

        const resultDiv = document.createElement('div');
        resultDiv.className = 'result-item success';
        resultDiv.innerHTML = `
          <strong>‚úì SUCCESS!</strong><br>
          webUtils.getPathForFile() works!<br>
          <em>Files: ${paths.map((p, i) => `${files[i].name} ‚Üí ${p}`).join('<br>')}</em>
        `;
        resultsDiv.appendChild(resultDiv);
      } else {
        log('[renderer] ‚úó ERROR: Could not get file paths')

        const resultDiv = document.createElement('div');
        resultDiv.className = 'result-item error';
        resultDiv.innerHTML = `
          <strong>‚ùå FAILED</strong><br>
          Neither f.path nor webUtils.getPathForFile() worked<br>
          <em>Files dropped: ${files.map(f => f.name).join(', ')}</em>
        `;
        resultsDiv.appendChild(resultDiv);
      }
    });

    // Listen for processing results
    if (window.fileDrop && window.fileDrop.onProcessed) {
      window.fileDrop.onProcessed((result) => {
        log('[renderer] File processed result: ' + JSON.stringify(result))

        const resultDiv = document.createElement('div');
        if (result.success) {
          resultDiv.className = 'result-item success';
          resultDiv.innerHTML = `
            <strong>‚úì SUCCESS</strong><br>
            Original: ${result.path}<br>
            Copy: ${result.copyPath}
          `;
        } else {
          resultDiv.className = 'result-item error';
          resultDiv.innerHTML = `
            <strong>‚úó FAILED</strong><br>
            Error: ${result.error}<br>
            Path: ${result.path || 'none'}
          `;
        }
        resultsDiv.appendChild(resultDiv);
      });
    }

    log('[renderer] Event listeners registered')
  </script>
</body>
</html>
